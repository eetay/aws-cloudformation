AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  RabbitClusterVPC:
    Type: String
  InstanceKeyPair:
    Type: String
  RabbitClusterVPCSubnets:
    Type: String
    Description: Subnets available in default VPC

#
# CloudFormation resources
#
Resources:



  #
  # Role that our cluster instances will assume to provide access to other AWS resources
  #
  RabbitClusterIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "ec2.amazonaws.com"
          Action:
          - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName: "RabbitClusterPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
              - "autoscaling:DescribeAutoScalingGroups"
              - "autoscaling:DescribeAutoScalingInstances"
              - "ec2:DescribeInstances"
              Resource: '*'

  RabbitClusterInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - !Ref RabbitClusterIamRole
      InstanceProfileName: "RabbitClusterInstanceProfile"

  RabbitClusterSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName: "RabbitClusterSG"
      GroupDescription: "Rabbit Cluster Instances Security Group"
      VpcId: !Ref RabbitClusterVPC
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: '0'
        ToPort: '65535'
        CidrIp: 0.0.0.0/0
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '22'
        ToPort: '22'
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: '4369'
        ToPort: '4369'
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: '5672'
        ToPort: '5672'
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: '15672'
        ToPort: '15672'
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: '25672'
        ToPort: '25672'
        CidrIp: 0.0.0.0/0

  RabbitClusterScalingLaunchConfiguration2:
    # example: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html#cfn-as-launchconfig-iaminstanceprofile
    DependsOn: RabbitClusterSG
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      IamInstanceProfile: "RabbitClusterInstanceProfile"
      AssociatePublicIpAddress: true
      # ImageId: "ami-cfe4b2b0" # AWS linux
      # ImageId: "ami-0682fcf8a18f7dcb7" # rabbit-1
      ImageId: "ami-0bc107842ebeeb7c0" # RabbitMQ-3.7.7
      SecurityGroups:
      - Fn::GetAtt:
        - RabbitClusterSG
        - GroupId
      InstanceType: "t2.micro"
      InstanceMonitoring: true
      LaunchConfigurationName: RabbitClusterScalingLaunchConfiguration2
      KeyName: !Ref InstanceKeyPair
      UserData:
        Fn::Base64:
          Fn::Join:
          - "\n"
          - - "#!/bin/bash -x"
            - "echo '' > /etc/rabbitmq/rabbitmq.conf"
            - "echo 'cluster_formation.peer_discovery_backend = rabbit_peer_discovery_aws' >> /etc/rabbitmq/rabbitmq.conf"
            - "echo 'cluster_formation.aws.region = us-east-1' >> /etc/rabbitmq/rabbitmq.conf"
            - "echo 'cluster_formation.aws.use_autoscaling_group = true' >> /etc/rabbitmq/rabbitmq.conf"
            - "echo 'log.file.level = debug' >> /etc/rabbitmq/rabbitmq.conf"
            - "echo 'log.console.level = debug' >> /etc/rabbitmq/rabbitmq.conf"
            - "sudo rm -f /var/log/rabbitmq/*"
            - "sudo service rabbitmq-server restart"
            - "sleep 3"
            - "rabbitmqctl add_user root root"
            - "rabbitmqctl set_permissions -p / root  '.*' '.*' '.*'"
            - "rabbitmqctl set_user_tags root administrator"
      BlockDeviceMappings:
      - Ebs:
          # SnapshotId: "snap-07ad5635357af8b3e"
          VolumeType: "gp2"
          # VolumeSize: 8
          DeleteOnTermination: true
        DeviceName: "/dev/xvda"

  RabbitClusterLB2:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      LoadBalancerName: "RabbitClusterLB2"
      HealthCheck:
        HealthyThreshold: "10"
        Interval: "30"
        Target: "TCP:5672" # "HTTP:15672/api/healthchecks/node"
        Timeout: "5"
        UnhealthyThreshold: "2"
      Listeners:
      - LoadBalancerPort: '22'
        InstancePort: '22'
        Protocol: "TCP"
      - LoadBalancerPort: '5672'
        InstancePort: '5672'
        Protocol: "TCP"
      - LoadBalancerPort: '15672'
        InstancePort: '15672'
        Protocol: "TCP"
      # Scheme: "internal"
      Scheme: "internet-facing"
      SecurityGroups:
        - !Ref RabbitClusterSG
      Subnets:
        Fn::Split:
          - ","
          - !Ref RabbitClusterVPCSubnets

  RabbitClusterInstancesASG:
    # UpdatePolicy:
    #   AutoScalingRollingUpdate:
    #     MinInstancesInService: "1"
    #     MaxBatchSize: "1"
    #     PauseTime: "PT12M5S"
    #     WaitOnResourceSignals: "true"
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: "RabbitClusterInstancesASG"
      MinSize: "3"
      MaxSize: "4"
      LoadBalancerNames:
      - "RabbitClusterLB2"
      # AvailabilityZones:
      #   Fn::GetAZs: !Ref "AWS::Region"
      LaunchConfigurationName: !Ref "RabbitClusterScalingLaunchConfiguration2"
      VPCZoneIdentifier:
        Fn::Split:
          - ","
          - !Ref RabbitClusterVPCSubnets
      Tags:
      - Key: "Name"
        Value: "RabbitClusterInstancesASG Instance"
        PropagateAtLaunch: true

